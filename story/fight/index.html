<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PastekoLore</title>
    <link rel="stylesheet" href="/style.css" />
    <script src="/utils.js"></script>
</head>



<body>

<canvas id="canvas" width="300" height="225" hidden="hidden"></canvas>

<iframe src="/template.html" onload="this.before((this.contentDocument.body||this.contentDocument).children[0]);this.remove();
    loadPage(
        'Pastek : En garde!',
        'Clique sur <strong>START</strong> pour dÃ©buter.',
        ' '
    );
    const img = document.getElementById('img');
    const canvas = document.getElementById('canvas');
    img.parentNode.replaceChild(canvas, img);
    const next = document.getElementById('next');
    next.hidden = true;
    canvas.hidden = false;
"></iframe>


<script>

let wrapper;
let gray_wrapper;
let intervalWrapperSizeUp;

let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let canvas_style = window.getComputedStyle(canvas);

let scene = document.createElement("canvas");
scene.width = canvas.width;
scene.height = canvas.height;
let scene_ctx = scene.getContext("2d");

let zoom = 1.0;
let shift_x = 0;
let shift_y = 0;

let __mouse_pos = {x: 0, y: 0};
let mouse_pos = {x: 0, y: 0};
let mouse_hover = false;

let __zoom;
let __shift_x;
let __shift_y;
let __camera_move_progression;
let intervalCamera;


let bg_music = new Audio();
let bg_loading = new Image();
let bg_image = new Image();
let pastek_idle = [new Image()];
let guard_idle = [new Image()];
let cursor = new Image();

bg_music.loop = true;
bg_music.src = "./goofy-ahh-fight.mp3";
bg_loading.src = "./loading.png";
bg_image.src = "./bg.png";
pastek_idle[0].src = "./pastek0.png";
guard_idle[0].src = "./guard0.png";
cursor.src = "./cursor.png";

let paragraph;
let __next_paragraph = "";
let __delete_text = false;
let intervalUpdateParagraph;

let intervalUpdateScreenShake;

bg_music.volume = 0.0;
let intervalMusicVolume;


canvas.onclick = () => {
    if (bg_music.paused) {
        FadeInMusic();
        ZoomMoveCamera(1.8, -80, 0);
        paragraph = document.getElementById("paragraph")
        wrapper = document.getElementById("white_wrapper");
        gray_wrapper = document.getElementById("gray_wrapper");
        changeParagraph("Le garde te bloque la sortie!<br><br>Il va falloir passer en force.");
        intervalWrapperSizeUp = setInterval(__sizeUpWrapper, 30);
        startScreenShake();
        return;
    }

};

canvas.onmousemove = (evt) => {
    // Get the mouse position relative to the canvas element.
    __mouse_pos.x = evt.clientX;
    __mouse_pos.y = evt.clientY;
}

canvas.onmouseover = () => {
    mouse_hover = true;
}
canvas.onmouseout = () => {
    mouse_hover = false;
}

function __updateScreenShake(){
    let progression = bg_music.currentTime;

    if (progression < 6.0 || (16.4 < progression && progression < 17.9) || (23.8 < progression && progression < 25.4)
        || (71.2 < progression)) {
        gray_wrapper.style.maxWidth = "900px";
        return;
    }

    const milliseconds_per_beat = 375;
    progression *= 1000; // convert to milliseconds
    zoom = __zoom + Math.min(0.1, Math.abs(Math.tan(progression / milliseconds_per_beat * Math.PI / 2))/100);
    gray_wrapper.style.maxWidth = 900 + Math.min(60, Math.abs(Math.tan(progression / milliseconds_per_beat * Math.PI / 2))*10) + "px";
}

function startScreenShake(){
    intervalUpdateScreenShake = setInterval(__updateScreenShake, 20);
}

function stopScreenShake(){
    clearInterval(intervalUpdateScreenShake);
}


function __sizeUpWrapper() {
    let max_width = window.getComputedStyle(wrapper).maxWidth;
    let int_max_width = parseInt(max_width, 10);
    if (int_max_width >= 900) {
        wrapper.style.maxWidth = "900px";
        clearInterval(intervalWrapperSizeUp);
        return;
    }
    wrapper.style.maxWidth = int_max_width + 5 + "px";
}


function __updateParagraph() {
    let length = paragraph.innerHTML.length;
    if (__delete_text)
        if (length > 0) {
            let next = paragraph.innerHTML
            if (next[next.length -1] === ">")
                while (next[next.length -1] !== "<")
                    next = next.slice(0, -1);
            paragraph.innerHTML = next.slice(0, -2);
        }
        else
            __delete_text = false;
    else if (length < __next_paragraph.length) {
        if (__next_paragraph[length] === "<")
            // noinspection StatementWithEmptyBodyJS
            while (__next_paragraph[length++] !== ">");
        paragraph.innerHTML = __next_paragraph.slice(0, length + 1);
    }
    else
        clearInterval(intervalUpdateParagraph);
}

/**
 * @param {string} newText
 */
function changeParagraph(newText) {
    __next_paragraph = newText;
    __delete_text = true;
    intervalUpdateParagraph = setInterval(__updateParagraph, 25);
}


function __updateMusicVolume(){
    if (bg_music.volume < 1.0){  // Fading intro
        try {
            bg_music.volume += 0.015; // Fading Music
        } catch {
            bg_music.volume = 1;
            clearInterval(intervalMusicVolume);
        }  // limit
    }
}


function __updateCameraMove() {

    __camera_move_progression += 0.02;
    if (__camera_move_progression >= 1.0){
        zoom = __zoom;
        shift_x = __shift_x;
        shift_y = __shift_y;
        return clearInterval(intervalCamera);
    }

    zoom += (__zoom - zoom) * __camera_move_progression;
    shift_x += (__shift_x - shift_x) * __camera_move_progression;
    shift_y += (__shift_y - shift_y) * __camera_move_progression;
}

function ZoomMoveCamera(_zoom = 1.0, _shift_x = 0, _shift_y = 0, duration = 1.0){
    __zoom = _zoom;
    __shift_x = _shift_x;
    __shift_y = _shift_y;
    __camera_move_progression = 0.0;
    intervalCamera = setInterval(__updateCameraMove, 20 * duration);
}

function FadeInMusic() {
    bg_music.play();
    intervalMusicVolume = setInterval(__updateMusicVolume, 30);
}

/**
 * @param {HTMLImageElement | SVGImageElement | HTMLVideoElement | HTMLCanvasElement | ImageBitmap} image
 * @param {number} pos_x
 * @param {number} pos_y
 * @param {number} transparency
 */
function drawTransparentImage(image, pos_x, pos_y, transparency) {
    if (transparency === 0.0)
        return;
    scene_ctx.globalAlpha = transparency;
    scene_ctx.drawImage(image, pos_x, pos_y);
    scene_ctx.globalAlpha = 1.0;
}

function updateScreen(){
    let width = canvas.width;
    let height = canvas.height;
    let new_width = width * zoom;
    let new_height = height * zoom;

    ctx.drawImage(
        scene, width / 2 - new_width / 2 - shift_x, height / 2 - new_height / 2 - shift_y, new_width, new_height );
}


function updateMousePos() {
    let rect = canvas.getBoundingClientRect();
    let true_width = parseInt(canvas_style.width, 10);
    let true_height = parseInt(canvas_style.height, 10);
    mouse_pos.x = canvas.width * (((__mouse_pos.x - rect.left) / true_width - 1/2) / zoom + 1/2) + shift_x/zoom;
    mouse_pos.y = canvas.height * (((__mouse_pos.y - rect.top) / true_height - 1/2) / zoom + 1/2) + shift_y/zoom;
}


function MainLoop(){


    scene_ctx.drawImage(bg_image, 0, 0);
    scene_ctx.drawImage(pastek_idle[0], 30, 80);
    scene_ctx.drawImage(guard_idle[0], 220, 80);

    drawTransparentImage(bg_loading, 0, 0, 1.0 - bg_music.volume);  // Fading image

    if (mouse_hover){
        updateMousePos();
        scene_ctx.drawImage(cursor, mouse_pos.x, mouse_pos.y, cursor.width / zoom, cursor.height / zoom)
    }

    updateScreen();
}

setInterval(MainLoop, 30);


</script>

</body>
</html>
